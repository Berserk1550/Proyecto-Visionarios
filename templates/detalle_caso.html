<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/detalle_caso.css">
  <title>Detalle del Caso</title>
</head>
<body>
  <!-- Contenedor principal -->
  <div id="padre_ppal">
    
    <h1>Detalle del Caso #{{ caso.num_caso }}</h1>

    <!-- Caja con la información del caso -->
    <div class="caja">
      <p><strong>Documento estudiante:</strong> {{ caso.documento }}</p>
      <p><strong>Tipo de caso:</strong> {{ caso.caso_tipo }}</p>
      <p><strong>Descripción:</strong> {{ caso.caso_descripcion }}</p>
      <p><strong>Fecha apertura:</strong> {{ caso.caso_fecha_apertura }}</p>
      <p><strong>Fecha cierre:</strong> {{ caso.caso_fecha_cierre or '---' }}</p>
      <p><strong>Estado:</strong> {{ caso.caso_estado }}</p>
    </div>

    <!-- Caja con las intervenciones -->
    <div class="caja">
      <h2>Intervenciones</h2>
      {% if intervenciones %}
      <table border="1" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Profesional</th>
            <th>Descripción</th>
            <th>Compromiso</th>
            <th>Estado compromiso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for intervencion in intervenciones %}
          <tr>
            <td>{{ intervencion.fecha }}</td>
            <td>{{ intervencion.doc_pronal }}</td>
            <td>{{ intervencion.descripcion }}</td>
            <td>{{ intervencion.int_compromiso }}</td>
            <td>{{ intervencion.int_estado_compromiso }}</td>
            <td>
              {% if intervencion.int_estado_compromiso != 'cumplido' %}
              <form action="{{ url_for('marcar_cumplido', id_intervencion=intervencion.id) }}" method="POST" style="display:inline;">
                <button type="submit">Marcar como cumplido</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No hay intervenciones registradas.</p>
      {% endif %}
    </div>

    <!-- Caja con acciones -->
    <div class="caja cont_contenido">
      {% if session['rol'] in ['docente','coordinacion','profesional_apoyo','administrador'] and caso.caso_estado == 'abierto' %}
      <a href="{{ url_for('nueva_intervencion_form', num_caso=caso.num_caso) }}">Añadir intervención</a>
      {% endif %}

      {% if session['rol'] == 'administrador' and caso.caso_estado == 'abierto' %}
      <form action="{{ url_for('r_cerrar_caso', num_caso=caso.num_caso) }}" method="POST">
        <button type="submit">Cerrar caso</button>
      </form>
      {% endif %}
    </div>

    <!-- Mensajes flash -->
    {% with mensajes = get_flashed_messages(with_categories=true) %}
      {% if mensajes %}
      <div class="caja">
        <ul>
          {% for categoria, mensaje in mensajes %}
          <li style="color: green;">{{ mensaje }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    {% endwith %}

  </div>
</body>
</html>
